---
# This is to detect that no fsid and keyring are set
- hosts:
  - localhost
  tasks:
  - name: make tempfolder
    command: mktemp -d
    register: mktemp

- hosts:
  - all
  tasks:
  - name: cleanout old config
    file: name="{{ item }}" state=absent
    when: cleanup_old_config|bool
    with_items:
    - /etc/ceph/ceph.conf
    - /etc/ceph/ceph.client.admin.keyring
  - name: get conf files
    fetch: dest="{{hostvars['localhost'].mktemp.stdout}}/" src="{{ item }}"
    with_items:
    - /etc/ceph/ceph.conf
    - /etc/ceph/ceph.client.admin.keyring

- hosts:
  - localhost
  tasks:
  - name: find fsid
    script: scripts/getConf.py -f ceph.conf -c global -k fsid "{{ mktemp.stdout }}"
    register: global_fsid
    any_errors_fatal: true
  - name: find keyring
    script: scripts/getConf.py -f ceph.client.admin.keyring -c client.admin -k key "{{ mktemp.stdout }}"
    register: admin_keyring
    any_errors_fatal: true

# This was to detect that no fsid and keyring are set

- hosts:
  - MON[0]
  tasks:
  - name: generate new fsid when needed
    command: uuidgen
    register: cluster_fsid
  - name: Generate an administrator keyring, generate a client.admin user and add the user to the keyring.
    command: ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --set-uid=0 --cap mon 'allow *' --cap osd 'allow *' --cap mds 'allow'
  - name: get keyring
    script: scripts/getConf.py -f ceph.client.admin.keyring -c client.admin -k key "{{ hostvars['localhost'].mktemp.stdout }}"
    register: admin_keyring

# This was to find an/or generate fsid and keyring


- hosts:
  - all
  become: yes
  become_method: sudo
  roles:
  - { role: common, keyring: "{{hostvars[groups['MON'][0]].admin_keyring.stdout }}", fsid: "{{ hostvars[groups['MON'][0]].cluster_fsid.stdout }}" }

- hosts:
  - MON
  become: yes
  become_method: sudo
  roles:
  - add-mon

- hosts:
  - OSD
  become: yes
  become_method: sudo
  roles:
  - add-osd
